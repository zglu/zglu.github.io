/*! 
 * Copyright 2026 Zhigang Lu 
 * All rights reserved. 
 */
const CURRENT_YEAR=new Date().getFullYear();let unlockedIds=new Set();const TOTAL_DATA_POINTS=ZGLU_DATA.knowledge.length;function sanitizeData(){if(ZGLU_DATA.config.endYear===0)ZGLU_DATA.config.endYear=CURRENT_YEAR;ZGLU_DATA.tracks.forEach(t=>{if(t.end===0)t.end=CURRENT_YEAR});ZGLU_DATA.knowledge.forEach(k=>{if(k.to===0)k.to=CURRENT_YEAR})}
window.onload=()=>{if(typeof ZGLU_DATA!=='undefined'){sanitizeData();setupBrowser()}else{console.error("data.js not found.");document.getElementById('browser-label').innerText="DATA_ERROR"}};function setupBrowser(){const axis=document.getElementById('axis');const layer=document.getElementById('tracks-layer');axis.innerHTML="";layer.innerHTML="";const start=ZGLU_DATA.config.startYear;const end=ZGLU_DATA.config.endYear;const total=end-start;for(let i=0;i<=total;i++){const tick=document.createElement('div');tick.className='tick';const pos=(i/total)*100;tick.style.left=`${pos}%`;tick.innerText=start+i;axis.appendChild(tick)}
ZGLU_DATA.tracks.forEach(t=>{const row=document.createElement('div');row.className='track-row';const left=((t.start-start)/total*100);const width=((t.end-t.start)/total*100);row.innerHTML=`<div class="track-item" style="left:${left}%; width:${width}%; background:${t.color}">${t.name}</div>`;layer.appendChild(row)})}
function quickAsk(text){document.getElementById('user-input').value=text;sendMessage()}
function sendMessage(){const input=document.getElementById('user-input');const text=input.value.trim().toLowerCase();if(!text)return;addMessage(input.value,'user-msg');input.value='';let matches=ZGLU_DATA.knowledge.filter(k=>{return k.keywords.some(kw=>{const lowKw=kw.toLowerCase();const isExact=(lowKw===text);const isShorthand=lowKw.startsWith(text)&&text.length>=3;const isStandalone=new RegExp(`\\b${lowKw}\\b`,'i').test(text);return isExact||isShorthand||isStandalone})});if(matches.length>0){matches.sort((a,b)=>b.from-a.from);processMatches(matches)}else{let bestMatch=null;let minDistance=3;ZGLU_DATA.knowledge.forEach(k=>{k.keywords.forEach(kw=>{const dist=getLevenshteinDistance(text,kw);if(dist<minDistance){minDistance=dist;bestMatch=kw}})});setTimeout(()=>{if(bestMatch){addMessage(`No direct hit for "${text}". Did you mean <b style="cursor:pointer; color:var(--accent-color)" onclick="quickAsk('${bestMatch}')">${bestMatch}</b>?`,'bot-msg')}else{addMessage("I couldn't find a match in the genome. Try 'help' to see available tracks.",'bot-msg')}},350)}}
function processMatches(matches){matches.forEach((match,index)=>{unlockedIds.add(match.id);updateRank();setTimeout(()=>{let content="";if(match.isTable)content=generatePubTable();else if(match.isStatus)content=generateStatusTable();else if(match.isSkills)content=generateSkillsTable();else if(match.isContact)content=generateContactCard();else if(match.isGallery)content=match.answer+generateGallery();else content=match.answer;if(match.image){content+=`<div class="msg-image-container" style="margin-top: 10px;">
                    <img src="${match.image}" class="chat-img" onclick="window.open(this.src)">
                </div>`}
addMessage(content,'bot-msg');updateUI(match);if(match.isDownload)performDownload();},index*250)})}
function generatePubTable(){let html=`<table style="width:100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; color: #cbd5e1;">
        <thead>
            <tr style="border-bottom: 1px solid var(--accent-color); text-align: left;">
                <th style="padding: 5px;">Year</th>
                <th style="padding: 5px;">Journal</th>
                <th style="padding: 5px;">Title (Click to view)</th>
                <th style="padding: 5px;">Role</th>
            </tr>
        </thead>
        <tbody>`;ZGLU_DATA.publication_list.forEach(pub=>{const titleLink=`<a href="${pub.doi}" target="_blank" class="pub-link">${pub.title}</a>`;let roleColor="#94a3b8";if(pub.role.toLowerCase()==="first")roleColor="#38bdf8";if(pub.role.toLowerCase()==="co-first")roleColor="#818cf8";html+=`<tr style="border-bottom: 1px solid #334155;">
            <td style="padding: 8px 5px; color: #38bdf8;">${pub.year}</td>
            <td style="padding: 8px 5px; font-weight: bold;">${pub.journal}</td>
            <td style="padding: 8px 5px;">${titleLink}</td>
            <td style="padding: 8px 5px;"><span style="color: ${roleColor}; font-size: 9px; font-weight: bold; border: 1px solid ${roleColor}; padding: 1px 4px; border-radius: 3px;">${pub.role.toUpperCase()}</span></td>
        </tr>`});html+=`</tbody></table>`;return html}
function generateStatusTable(){let html=`<table style="border-collapse: collapse; font-size: 12px; margin-top: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
        <tbody>`;for(const[key,value]of Object.entries(ZGLU_DATA.status)){html+=`<tr style="border-bottom: 1px solid #334155;">
            <td style="padding: 8px; color: #38bdf8; font-weight: bold; width: 40%;">${key}</td>
            <td style="padding: 8px; color: #f8fafc;">${value}</td>
        </tr>`}
html+=`</tbody></table>`;return html}
function generateSkillsTable(){let html=`<table style="border-collapse: collapse; font-size: 11px; margin-top: 10px; color: #cbd5e1;">
        <tbody>`;ZGLU_DATA.skills_matrix.forEach(item=>{html+=`<tr style="border-bottom: 1px solid #334155;">
            <td style="padding: 10px 5px; color: #38bdf8; font-weight: bold; width: 30%; vertical-align: top;">${item.category}</td>
            <td style="padding: 10px 5px; line-height: 1.5;">${item.tools}</td>
        </tr>`});html+=`</tbody></table>`;return html}
function generateGallery(){let html=`<div class="gallery-grid">`;ZGLU_DATA.gallery_data.forEach(item=>{html+=`
            <div class="gallery-item" onclick="window.open('${item.url}')">
                <img src="${item.url}" class="gallery-img">
                <div class="gallery-overlay">
                    <b>${item.title}</b>
                </div>
            </div>`});html+=`</div>`;return html}
function generateContactCard(){const info=ZGLU_DATA.contact_info;return `
    <div style="background: rgba(56, 189, 248, 0.05); border: 1px solid var(--accent-color); border-radius: 12px; padding: 20px; margin-top: 10px; text-align: center;">
        <div style="font-size: 18px; font-weight: bold; color: var(--accent-color); margin-bottom: 5px;">Dr. Zhigang Lu (He/Him)</div>
        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 15px;">Bioinformatics Field Specialist</div>
        
        <div style="text-align: left; font-size: 13px; margin-bottom: 20px; display: inline-block;">
            <div style="margin: 5px 0;">üìç ${info.location}</div>
            <div style="margin: 5px 0;">üåê ${info.web}</div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: center;">
            <a href="mailto:${info.email}" style="background: var(--bot-msg); color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; font-size: 12px;">SEND EMAIL</a>
            <a href="${info.linkedin}" target="_blank" style="border: 1px solid var(--accent-color); color: var(--accent-color); text-decoration: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; font-size: 12px;">LINKEDIN</a>
            <a href="${info.gscholar}" target="_blank" style="border: 1px solid var(--accent-color); color: var(--accent-color); text-decoration: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; font-size: 12px;">G.SCHOLAR</a>
        </div>
    </div>
    `}
function addMessage(text,type){const flow=document.getElementById('chat-flow');const div=document.createElement('div');div.className=`message ${type}`;const now=new Date();const timeStr=now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');div.innerHTML=`
        <div class="msg-content">${text}</div>
        <span class="timestamp">${timeStr}</span>
    `;flow.appendChild(div);flow.scrollTop=flow.scrollHeight}
function updateUI(data){const hl=document.getElementById('highlight');const label=document.getElementById('browser-label');const startYear=ZGLU_DATA.config.startYear;const endYear=ZGLU_DATA.config.endYear;const totalDuration=endYear-startYear;const getX=(year)=>{const rawPercent=(year-startYear)/totalDuration;return(rawPercent*90)+5};if(data.from&&data.to){const leftPos=getX(data.from);const rightPos=getX(data.to);hl.style.left=`${leftPos}%`;hl.style.width=`${rightPos - leftPos}%`}else{hl.style.left=`5%`;hl.style.width=`90%`}
label.innerText=data.label}
function performDownload(){const pdfUrl=ZGLU_DATA.config.pdfFile;const a=document.createElement('a');a.href=pdfUrl;a.target='_blank';document.body.appendChild(a);a.click();document.body.removeChild(a)}
function getLevenshteinDistance(a,b){const matrix=[];for(let i=0;i<=b.length;i++)matrix[i]=[i];for(let j=0;j<=a.length;j++)matrix[0][j]=j;for(let i=1;i<=b.length;i++){for(let j=1;j<=a.length;j++){if(b.charAt(i-1)===a.charAt(j-1)){matrix[i][j]=matrix[i-1][j-1]}else{matrix[i][j]=Math.min(matrix[i-1][j-1]+1,Math.min(matrix[i][j-1]+1,matrix[i-1][j]+1))}}}
return matrix[b.length][a.length]}
let lastRankTitle="";function updateRank(){const count=unlockedIds.size;const total=ZGLU_DATA.knowledge.length;const progressPct=(count/total)*100;const ranks=ZGLU_DATA.achievements.ranks;let currentRank=ranks[0];for(let r of ranks){if(progressPct>=r.pct)currentRank=r}
document.getElementById('rank-text').innerText=`${currentRank.title.toUpperCase()}`;document.getElementById('rank-text').style.color=currentRank.color;document.getElementById('xp-bar').style.width=`${progressPct}%`;document.getElementById('xp-bar').style.background=currentRank.color;if(currentRank.title!==lastRankTitle&&lastRankTitle!==""){addMessage(`<span class="sys-notification">‚ú® <b>SECURITY CLEARANCE INCREASED:</b><br>
            You have reached rank <b>[${currentRank.title}]</b>.<br>
            ${currentRank.desc}</span>`,'bot-msg')}
lastRankTitle=currentRank.title}
function acceptDisclaimer(){const overlay=document.getElementById('disclaimer-overlay');overlay.style.transition="opacity 0.8s ease";overlay.style.opacity="0";setTimeout(()=>{overlay.style.display="none";addMessage("<b>SYSTEM ONLINE:</b> Credentials verified for User. Accessing encrypted career tracks for Dr. Zhigang Lu...","bot-msg");updateRank()},800)}